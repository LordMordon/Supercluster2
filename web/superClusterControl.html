<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSerial MCU Controller</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #121212;
      color: #eee;
    }
    button, input[type="number"] {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #333;
      color: #eee;
      cursor: pointer;
    }
    input[type="number"] {
      width: 60px;
    }
    button:hover {
      background-color: #555;
    }
    .status {
      font-weight: bold;
      color: lightgreen;
      margin-left: 10px;
    }
    #log {
      white-space: pre;
      border: 1px solid #444;
      background-color: #1e1e1e;
      color: #ccc;
      padding: 10px;
      max-height: 200px;
      overflow-y: scroll;
      margin-top: 20px;
    }
    .control-row {
      display: flex;
      align-items: center;
      margin: 10px 0;
      gap: 10px;
    }
    .mcu-grid {
      display: grid;
      grid-template-columns: repeat(16, 10px);
      grid-gap: 2px;
      margin: 10px 0;
    }
    .mcu-box {
      width: 10px;
      height: 10px;
      background-color: gray;
    }
    .mcu-box.active {
      background-color: lime;
    }
  </style>
</head>
<body>
  <h1>MCU Control App</h1>

  <button id="connectBtn">Connect</button>
  <span id="status" class="status">Disconnected</span>

  <div class="control-row">
    <button id="setIndexBtn">Set Index</button>
    <input type="range" id="indexSlider" min="0" max="240" step="16" value="0">
    <span id="indexValue">0</span>
  </div>

  <div class="control-row">
    <label for="ledIndex">LED Index:</label>
    <input type="number" id="ledIndex" value="255" min="0" max="255">
    <button id="ledBtn">Toggle LED</button>
  </div>

  <div class="control-row">
    <button id="pingBtn">Ping</button>
  </div>

  <div class="control-row">
    <label for="idCoord">ID:</label>
    <input type="number" id="idCoord" value="0" min="0" max="255">
    <label for="ox">OX:</label>
    <input type="number" id="ox" value="0">
    <label for="oy">OY:</label>
    <input type="number" id="oy" value="0">
    <label for="oz">OZ:</label>
    <input type="number" id="oz" value="0">
    <label for="vx">VX:</label>
    <input type="number" id="vx" value="0">
    <label for="vy">VY:</label>
    <input type="number" id="vy" value="0">
    <label for="vz">VZ:</label>
    <input type="number" id="vz" value="65536">
    <button id="renderPixelBtn">Render Pixel</button>
  </div>

  <h3>MCU Status</h3>
  <div id="mcuStatus"></div>
  <div class="mcu-grid" id="mcuGrid"></div>

  <h3>Response Log</h3>
  <div id="log"></div>

  <script>
    const BUS_SET_INDEX = 0xf0;
    const BUS_LED = 0xe0;
    const BUS_PING = 0xf8;
    const BUS_RAYMARCHER_RENDER_PIXEL = 0x41;

    let port = null;
    let reader = null;
    let writer = null;
    let readBuffer = [];

    const mcuGrid = document.getElementById("mcuGrid");
    const mcuBoxes = [];
    for (let i = 0; i < 160; i++) {
      const div = document.createElement("div");
      div.className = "mcu-box";
      mcuGrid.appendChild(div);
      mcuBoxes.push(div);
    }

    async function connectSerial() {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        writer = port.writable.getWriter();
        reader = port.readable.getReader();

        document.getElementById("status").textContent = "Connected";
        document.getElementById("status").style.color = "lightgreen";

        readLoop();
      } catch (err) {
        console.error("Connection error:", err);
        document.getElementById("status").textContent = "Disconnected";
        document.getElementById("status").style.color = "red";
      }
    }

    async function readLoop() {
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            readBuffer.push(...value);
            processBufferedData();
          }
        }
      } catch (err) {
        console.error('Read error:', err);
      }
    }

    function processBufferedData() {
      while (readBuffer.length >= 2) {
        const length = readBuffer[0];
        if (readBuffer.length >= length + 1) {
          const packet = readBuffer.slice(0, length + 1);
          readBuffer = readBuffer.slice(length + 1);
          handleResponse(new Uint8Array(packet));
        } else {
          break;
        }
      }
    }

    function handleResponse(value) {
      const id = value[1];
      if (id === BUS_PING) {
        document.getElementById("mcuStatus").textContent = 'MCU Status: ' + [...value].map(b => b.toString(16).padStart(2, '0')).join(' ');
        for (let i = 0; i < mcuBoxes.length; i++) {
          mcuBoxes[i].classList.remove("active");
        }
        for (let i = 2; i < value.length && i - 2 < mcuBoxes.length; i++) {
          if (value[i]) {
            mcuBoxes[i - 2].classList.add("active");
          }
        }
      }
      const hex = [...value].map(b => b.toString(16).padStart(2, '0')).join(' ');
      log("RX: " + hex);
    }

    async function sendInstruction(instruction, data = []) {
      if (!writer) return;
      const payload = new Uint8Array([instruction, ...data]);
      await writer.write(payload);
      log("TX: " + [...payload].map(b => b.toString(16).padStart(2, '0')).join(' '));
    }

    function log(text) {
      const logEl = document.getElementById("log");
      logEl.textContent += text + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    document.getElementById("connectBtn").addEventListener("click", connectSerial);

    const slider = document.getElementById("indexSlider");
    const indexValue = document.getElementById("indexValue");
    slider.addEventListener("input", () => {
      indexValue.textContent = slider.value;
    });

    document.getElementById("setIndexBtn").addEventListener("click", () => {
      const index = parseInt(slider.value);
      sendInstruction(BUS_SET_INDEX, [index]);
    });

    document.getElementById("ledBtn").addEventListener("click", () => {
      const ledIndex = parseInt(document.getElementById("ledIndex").value) || 0;
      sendInstruction(BUS_LED, [ledIndex]);
    });

    document.getElementById("pingBtn").addEventListener("click", () => {
      sendInstruction(BUS_PING);
    });

    document.getElementById("renderPixelBtn").addEventListener("click", () => {
      const id = parseInt(document.getElementById("idCoord").value) || 0;
      const ox = parseInt(document.getElementById("ox").value) || 0;
      const oy = parseInt(document.getElementById("oy").value) || 0;
      const oz = parseInt(document.getElementById("oz").value) || 0;
      const vx = parseInt(document.getElementById("vx").value) || 0;
      const vy = parseInt(document.getElementById("vy").value) || 0;
      const vz = parseInt(document.getElementById("vz").value) || 0;

      const encode32 = val => [val & 0xFF, (val >> 8) & 0xFF, (val >> 16) & 0xFF, (val >> 24) & 0xFF];
      const data = [id, ...encode32(ox), ...encode32(oy), ...encode32(oz), ...encode32(vx), ...encode32(vy), ...encode32(vz)];

      sendInstruction(BUS_RAYMARCHER_RENDER_PIXEL, data);
    });

    window.addEventListener('DOMContentLoaded', async () => {
      if ('serial' in navigator) {
        const ports = await navigator.serial.getPorts();
        if (ports.length > 0) {
          try {
            port = ports[0];
            await port.open({ baudRate: 115200 });
            writer = port.writable.getWriter();
            reader = port.readable.getReader();
            document.getElementById("status").textContent = "Connected";
            document.getElementById("status").style.color = "lightgreen";
            readLoop();
          } catch (err) {
            console.error("Auto-connect error:", err);
          }
        }
      }
    });
  </script>
</body>
</html>
